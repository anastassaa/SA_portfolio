# Свод

**Получение файла:**

Загрузка Excel-файлов (формат .xls, .xlsx, .xlsm) через веб-интерфейс после поступления ответов от СК в раздел CRM «ДЕЛА» и подтверждения брокера для запуска сервиса Свода.
Пример файла: KLResult_e6c48b6d-a7af-4fed-9156-c9c8c714242
Шаблон: KLResult_<GUID_сделки>

## Задача 1 : Актуализировать лист КЛ в Котировочном листе

**Актуализация КЛ:**

1. Добавлен пункт **6 «Франшиза»** (строки 43-47), где
   - В ячейках *E45, E46, H45, H46* из выпадающего списка выбирается вид франшизы для основного риска;
   - В ячейках *D45, D46, G45, G46* указываются значения франшиз, которые одинаковы для каждого типа имущества. (*Значения из этих ячеек будут автоматически копироваться в соответствующие ячейки в каждом типе недвижимости, указанном в пункте 7. Подробнее в пункте 5.)*
2. Блок сдвинулся на 1 пункт, **"6. Ответ СК/андеррайтера"** → **"7. Ответ СК/андеррайтера"**
3. В разделе **"Недвижимое имущество"** добавлено наименование первого блока - **"Прочая недвижимость"**, аналогично наименованию **"Склады"**.
4. Добавление строки с видом франшизы (в формате выпадающего списка) в каждом блоке доп.риска.
5. Поля **"Франшиза, запрошенная СББ", "Франшиза, предложенная СК"** внутри каждого блока автоматически заполняются в соответствии со значениями в ячейках  *D45, D46, G45, G46* и становятся неактивными для редактирования, подсвечиваются серым.

## **Задача 2: Разработка алгоритма обработки полученного КЛ**  **(только лист КЛ)**

   1. ### Основная информация

   Читаем в строке ячейки *B4, G4*.

Таблица 1. Маппинг полей 4 строки.

| **Поле КЛ**   | **Ячейка** | **Параметр** | Описание                                                                       |
| ------------- | ---------- | ------------ | ------------------------------------------------------------------------------ |
| Номер запроса | B4         | dealId       |                                                                                |
| Статус СК     | G4         | status       | **Варианты:<br>- Предложены условия,<br>- Запрос доп. информации,<br>- Отказ** |

   В зависимости от значения в поле *G4* определяем, добавлять ли данные из КЛ в СВОД:

         Таблица 2. Статусная модель КЛ.

| Значение поля G4       | Действие                                                       |
| ---------------------- | -------------------------------------------------------------- |
| Предложены условия     | Переносим данные в СВОД                                        |
| Запрос доп. информации | Отправляем брокеру сообщение, в СВОД данные из КЛ не переносим |
| Отказ                  | Переносим данные в СВОД                                        |

2. ### Обработка раздела с Франшизой

   Далее читаем со строки 43-46, блок "6. Франшиза".

   - Если в ячейке *А43* значение "6. Франшиза", то начинаем обработку этого раздела.
   - Проверка содержимого ячеек в строке 44, если значения не соответствуют, завершаем обработку, так как файл не соответствует шаблону.
      - D44 = ОТ ВСЕХ РИСКОВ
      - G44 = ОТ ПОИМЕНОВАННЫХ РИСКОВ
   - Проверка содержимого в ячейке *A45*, если значение равно "6.1 Франшиза, запрошенная СББ", то начинаем чтение блока SBB, где сохраняем параметры из ячеек. Если ячейка пустая, сохраняем значение параметра как `null`. ::Но, минимум одно из полей с суммой должно быть заполнено.::

Таблица 3. Маппинг полей 45 строки.

| **Ячейка** | **Поле КЛ**                      | **Параметр**                  |
| ---------- | -------------------------------- | ----------------------------- |
| D45        | Сумма франшизы СББ allRisks      | SBBFranchiseValueOfAllRisks   |
| E45        | Выбор из значений из справочника | SBBFranchiseTypeOfAllRisks    |
| G45        | Сумма франшизы СББ namedRisks    | SBBFranchiseValueOfNamedRisks |
| H45        | Выбор из значений из справочника | SBBFranchiseTypeOfNamedRisks  |

   - Проверка содержимого в ячейке A46, если значение равно "6.2 Франшиза, предложенная СК", то начинаем чтение блока IC, где сохраняем параметры из ячеек. Если ячейка пустая, сохраняем значение параметра как `null`. ::Но, минимум одно из полей с суммой должно быть заполнено.::

Таблица 4. Маппинг полей 46 строки.

| **Ячейка** | **Поле КЛ**                      | **Параметр**                 |
| ---------- | -------------------------------- | ---------------------------- |
| D46        | Сумма франшизы СК allRisks       | ICFranchiseValueOfAllRisks   |
| E46        | Выбор из значений из справочника | ICFranchiseTypeOfAllRisks    |
| G46        | Сумма франшизы СК namedRisks     | ICFranchiseValueOfNamedRisks |
| H46        | Выбор из значений из справочника | ICFranchiseTypeOfNamedRisks  |

- Поля E45, E46, H45, H46 могут иметь одно из 4 значений в соответствии со справочником видов франшиз - Таблица 5. Процентные величины требуют преобразования в абсолютные значения для дальнейших расчетов.

   Таблица 5. Справочник видов франшиз.

| Вид франшизы           | **Формат**                               | **Преобразование**                                                              | **Параметр**            |
| ---------------------- | ---------------------------------------- | ------------------------------------------------------------------------------- | ----------------------- |
| Безусловная процентная | %, 2 знака после занятой (пример: 0,50%) | в абсолютное, с округлением до 10-ти тысячных<br>(пример: 0,50 / 100  = 0,0050) | UnconditionalPercentage |
| Безусловная абсолютная | 10000,5000                               | округление до сотых (пример: 10000,50)                                          | UnconditionalAbsolute   |
| Условная процентная    | %, 2 знака после занятой (пример: 0,50%) | в абсолютное, с округлением до 10-ти тысячных<br>(пример: 0,50 / 100  = 0,0050) | ConditionalPercentage   |
| Условная абсолютная    | 10000,5000                               | округление до сотых (пример: 10000,50)                                          | ConditionalAbsolute     |

Таблица 6. Полный маппинг полей блока "6.Франшиза".

| **Ячейка** | **Поле КЛ**                      | **Описание/Параметр**               |
| ---------- | -------------------------------- | ----------------------------------- |
| A43        | 6. Франшиза                      | Начало работы                       |
| D44        | ОТ ВСЕХ РИСКОВ                   | Проверка значения                   |
| G44        | ОТ ПОИМЕНОВАННЫХ РИСКОВ          | Проверка значения                   |
| A45        | 6.1 Франшиза, запрошенная СББ    | Проверка значения, начало блока SBB |
| D45        | Сумма франшизы СББ allRisks      | SBBFranchiseValueOfAllRisks         |
| E45        | Выбор из значений из справочника | SBBFranchiseTypeOfAllRisks          |
| G45        | Сумма франшизы СК namedRisks     | SBBFranchiseValueOfNamedRisks       |
| H45        | Выбор из значений из справочника | SBBFranchiseTypeOfNamedRisks        |
| A46        | 6.2 Франшиза, предложенная СК    | Проверка значения, начало блока IC  |
| D46        | Сумма франшизы СК allRisks       | ICFranchiseValueOfAllRisks          |
| E46        | Выбор из значений из справочника | ICFranchiseTypeOfAllRisks           |
| G46        | Сумма франшизы СК namedRisks     | ICFranchiseValueOfNamedRisks        |
| H46        | Выбор из значений из справочника | ICFranchiseTypeOfNamedRisks         |

**JSON блока "6. Франшиза"**

```javascript
{
      "Франшиза": {
        "От всех рисков": {
          "6.1 Франшиза, запрошенная СББ": {
            "Значение": 0.0005,
            "Тип": "Условная процентная"
          },
          "6.2 Франшиза, предложенная СК": {
            "Значение": 0.30,
            "Тип": "Условная абсолютная"
          }
        },
        "От поименованных рисков": {
          "6.1 Франшиза, запрошенная СББ": {
            "Значение": 0.0004,
            "Тип": "Безусловная процентная"
          },
          "6.2 Франшиза, предложенная СК": {
            "Значение": 0.50,
            "Тип": "Безусловная абсолютная"
          }
        }
      }
  }
//ининглиш плиз
  {
      "Franchise": {
        "allRisks": {
          "SBBFranchise": {
            "Value": 0.0005,
            "Type": "UnconditionalPercentage"
          },
          "ICFranchise": {
            "Value": 0.30,
            "Type": "UnconditionalAbsolute"
          }
        },
        "namedRisks": {
          "SBBFranchise": {
            "Value": 0.0004,
            "Type": "UnconditionalPercentage"
          },
          "ICFranchise": {
            "Value": 0.50,
            "Type": "UnconditionalAbsolute"
          }
        }
      }
	}
```

3. ### Обработка раздела с ответом СК

3.1 Если в ячейке *А48* значение "7. Ответ СК/андеррайтера", то начинаем обработку этого блока. Если нет, то завершаем обработку, файл не соответствует шаблону.

*3.2 Далее обрабатываем построчно поля, начиная с 49 строки в границах столбцов A-K.*

3.3 В ячейке *A49* должно быть указано одно из значений:

Таблица 7. Список категорий ИМЩ

| Виды имущества                       |
| ------------------------------------ |
| НЕДВИЖИМОЕ ИМУЩЕСТВО                 |
| ДВИЖИМОЕ ИМУЩЕСТВО                   |
| ТМЦ                                  |
| ЗЕМЕЛЬНЫЕ УЧАСТКИ                    |
| ОБЪЕКТЫ НЕЗАВЕРШЕННОГО СТРОИТЕЛЬСТВА |

```javascript
estateType.conf
{
	"EstateType": ["realEstate", "warehouses"],
	"movableEstate",
    "currentAssets",
	"landPlot",
	"constructionInProgress"
}
```

   Если значение из таблицы найдено, начинаем обработку этого блока. Обрабатываем последующие строки по данному блоку до значения в **столбце A** = "Комментарий UW (опционально)". Это знак окончания блока.  *::Важно! Если указано "НЕДВИЖИМОЕ ИМУЩЕСТВО", то далее в ячейке A51 должно быть указан вид недвижимого имущества: "Прочая недвижимость" или "Склады". Если этого нет, то файл не соответствует шаблону.::*

3.4 Проверка содержимого ячеек в строке 50, если значения не соответствуют, завершаем обработку, так как файл не соответствует шаблону. ::Минимум одно из полей должно быть заполнено.::

      - A50 = ОТ ВСЕХ РИСКОВ
      - G50 = ОТ ПОИМЕНОВАННЫХ РИСКОВ

3.5 Проверка заполнения ячейки A51. Здесь может быть 3 варианта:

      - Поле пустое -  для всех видом ИМЩ, кроме НЕДВИЖИМОЕ ИМУЩЕСТВО
      - "Прочая недвижимость" - в НЕДВИЖИМОЕ ИМУЩЕСТВО
      - "Склады" - в  НЕДВИЖИМОЕ ИМУЩЕСТВО

3.6 Проверка содержимого ячеек в строке 52:

      - Проверяем структуру столбцов раздела «С франшизой»:

         · **A52, G52** = "С франшизой"

         · **B52, H52** = "Оценочная стоимость"

         · **D52, J52** = "Залоговая стоимость"

         · **A52, G52** = "Суммы"

         *Если все ячейки строки 52 заполнены корректно, то читаем значения сумм в столбцах **B, D, H, J** следующей строки:*

            - Если ячейка пустая, помечаем её как null;
            - Если ячейка заполнена, то проверяем формат (Целое число, возможно 2 знака после запятой), сохраняем значение. В итоговом json это будет значение параметра amount в каждом из блоков.

   3.7 Далее пропускаем 2 строки (эти же значения были взяты ранее из п. 6 Франшиза) и начинаем читать строку *56.*

      Таблица 8. Формат полей Нетто-тариф с/без РНПК.

|          Ячейка   |          Поле                       |          Ячейка со значением              |          Требования к значению в ячейке             |
| ----------------- | ----------------------------------- | ----------------------------------------- | --------------------------------------------------- |
|          A56, G56 |          Нетто-тариф без СО РНПК, % |          B56 и/или D56, <br>H56 и/или J56 | В процентах, округление до 10-ти тысячных (0,1100%) |
|          A57, G57 |          Нетто-тариф с СО РНПК, %   |          B56 и/или D56, <br>H56 и/или J56 | \-//-                                               |

   ::ПРОВЕРКА: Как минимум одна пара **"Суммы"** (Оценочная стоимость или Залоговая стоимость) **- "Нетто-тариф"** (Оценочная стоимость или Залоговая стоимость) соответственно должны быть заполнены. *Если ни одно из полей с тарифом не заполнено, такой котировочный лист не участвует в формировании Сводной формы.*::

![image.png](https://res.craft.do/user/full/673239f1-0c36-ddbd-8df7-44afc5cea554/doc/e4ef609f-2940-48dc-b1c8-a263c75155a3/5824c458-058b-421b-81c4-94cb55cc81b8)

   3.8 Проверяем наличие раздела «Без франшизы»

   - Проверяем значение в ячейках *A58, G58* = «Без франшизы». Если ячейка пустая или заполнена другим значением, то считаем, ::что файл не соответствует шаблону.::
   - Если ячейка заполнена корректно, то читаем следующие 2 строки:

   Таблица 9. Формат полей Нетто-тариф со/без складской оговоркой.

| Ячейка   | Поле                                  | Ячейка со значением              | Требования к значению в ячейке                      |
| -------- | ------------------------------------- | -------------------------------- | --------------------------------------------------- |
| A59, G59 | Нетто-тариф без складской оговорки, % | B59 и/или D59,<br>H59 и/или J59  | В процентах, округление до 10-ти тысячных (0,1100%) |
| A60, G60 | Нетто-тариф со складской оговоркой, % | B60 и/или D60, <br>H60 и/или J60 | \-//-                                               |

   3.9 Пропускаем 1 строку и читаем следующий раздел, есть он есть: *В ячейке A62 может быть:*

      - *"Склады" из блока "Недвижимое имущество",* *→ читаем их аналогично первому блоку*
      - *"Доп. риск:",* *→ начинаем читать этот блок, см.п4*
      - *"*Комментарий UW (опционально):*"* → читаем B62, где будет текст комментария. После чего чтение блока завершается, так как каждый блок всегда завершается параметром "Комментарий UW (опционально):".
   4. Чтение раздела "Доп.риски:" 
4.1 Раздел "Доп. риски:" прописывается через 1 строку после предыдущего блока с описанием основных рисков. В разделе может быть несколько доп. рисков, каждый  из них прописывается отдельной таблицей, между таблицами 1 пустая строка. Структура первой строки раздела (обязательна к заполнению):

      Таблица 10. Структура заголовков Доп.риски.

| Столбец | Значение в ячейке |
| ------- | ----------------- |
| A       | Доп.риск:         |
| B       | Лимит запрошенный |
| D       | Лимит по риску    |

      4.2 В столбце А следующей строки прописывается доп. риск из таблицы 11. В столбцах B и D этой же строки указываются суммы лимитов с округлением до сотых. ::Должна быть указана хотя бы одна сумма (Лимит запрошенный / Лимит по риску).::

      Таблица 11. Справочник доп. рисков.

| Наименование риска                                                                                                                          |
| ------------------------------------------------------------------------------------------------------------------------------------------- |
| Теракт и диверсия на лимит 1                                                                                                                |
| Теракт и диверсия на лимит 2                                                                                                                |
| Гражданские и/или народные волнения, массовые беспорядки, забастовки                                                                        |
| Гражданская война, мятеж, восстание, военное восстание, бунт, революция, военный переворот или захват власти, военное или осадное положение |
| Страхование перерыва в производстве                                                                                                         |
| Страхование гражданской ответственности                                                                                                     |
| Страхование поломки оборудования                                                                                                            |
| Страхование экологических рисков                                                                                                            |
| Титул                                                                                                                                       |
| Страхование Кибер-рисков                                                                                                                    |

      4.3 Раздел заполняется в соответствии с таблицей 12. После строки с наименованием риска в столбце А ожидается поле "Вид франшизы". В столбцах В и/или D заполняется видом франшизы в соответствии со справочником (таблица 5). Размер франшизы указан в следующей строке, где в столбце А ожидается значение "Франшиза", а в столбцах В и/или D указывается само значение. Последняя строка данного раздела начинается со столбца А, где указывается поле "Нетто-тариф, %", значения Нетто-тарифа указываются в процентах с округлением до 10-ти тысячных (0,1100%)  в столбцах  B,D.

      Таблица 12. Заполнение раздела доп. рисков.

| Строка | Столбец А                | Столбец B                                         | Столбец D                                        |
| ------ | ------------------------ | ------------------------------------------------- | ------------------------------------------------ |
| N      | Доп.риск:                | Лимит запрошенный                                 | Лимит по риску                                   |
| N+1    | <Значение из таблицы 11> | <Значение округляется до сотых> <br>Пример: 10,00 | <Значение округляется до сотых> <br>Пример: 8,00 |
| N+2    | Вид франшизы             | <Значение из таблицы 5>                           | <Значение из таблицы 5>                          |
| N+3    | Франшиза                 | 0,50%                                             | 0,1                                              |
| N+4    | Нетто-тариф, %           | 0,1000%                                           | 0,0500%                                          |

      ::ПРОВЕРКА: Как минимум одна пара **сумма Лимита запрошенного** / **сумма Лимита по риску - "Нетто-тариф"** **Лимита запрошенного** /  **"Нетто-тариф"** **Лимита по риску** соответственно должны быть заполнены. *Если ни одна пара не заполнена, то риск не переносим в СВОД???.*::

   4.4 Раздел доп. рисков завершается, когда после 1 пустой строки было найдено значение "Комментарий UW (опционально):" в столбце А. Эта строка является последней внутри одного вида имущества.

   5. В разделе **"7. Ответ СК/андеррайтера"** могут быть указаны риски к нескольким видам недвижимости. Между собой блоки с разными видами недвижимости разделяются 2-мя пустыми сроками. Таким образом есть 2 сценария:
- ячейка в столбце А, N+3 строке, *где N - строка с комментарием UW* пустая или в ней значение не из списка видов имущества (таблица 7), то завершаем чтение файла КЛ.

- в ячейке столбца А, N+3 строки, *где N - строка с комментарием UW* найдено одно из наименований вида имущества (таблице 7), то начинаем чтение нового блока, аналогично предыдущему.

   ### JSON ответа сервиса КЛ

```javascript

```


