# Свод

## Задача 1 : Актуализировать лист КЛ в Котировочном листе

**Актуализация КЛ:**

1. Добавлен пункт **6 «Франшиза»** (строки 43-47), где
   - В ячейках *E45, E46, H45, H46* из выпадающего списка выбирается вид франшизы для основного риска;
   - В ячейках *D45, D46, G45, G46* указываются значения франшиз, которые одинаковы для каждого типа имущества. (*Значения из этих ячеек будут автоматически копироваться в соответствующие ячейки в каждом типе недвижимости, указанном в пункте 7. Подробнее в пункте 5.)*
2. Блок сдвинулся на 1 пункт, **"6. Ответ СК/андеррайтера"** → **"7. Ответ СК/андеррайтера"**
3. В разделе **"Недвижимое имущество"** добавлено наименование первого блока - **"Прочая недвижимость"**, аналогично наименованию **"Склады"**.
4. Добавление строки с видом франшизы (в формате выпадающего списка) в каждом блоке доп.риска.
5. Поля **"Франшиза, запрошенная СББ", "Франшиза, предложенная СК"** внутри каждого блока автоматически заполняются в соответствии со значениями в ячейках  *D45, D46, G45, G46* и становятся неактивными для редактирования, подсвечиваются серым.

## **Задача 2: Разработка алгоритма обработки полученного КЛ**  **(только лист КЛ)**

   1. ### Основная информация

   Читаем в строке ячейки B4, G4.

Таблица 1. Маппинг полей 4 строки.

| **Поле КЛ**   | **Ячейка** | **Параметр** | Описание                                                                       |
| ------------- | ---------- | ------------ | ------------------------------------------------------------------------------ |
| Номер запроса | B4         | dealId       |                                                                                |
| Статус СК     | G4         | status       | **Варианты:<br>- Предложены условия,<br>- Запрос доп. информации,<br>- Отказ** |

   В зависимости от значения в поле G4 определяем, добавлять ли данные из КЛ в СВОД:

         Таблица 2. Статусная модель КЛ.

| Значение поля G4       | Действие                                                       |
| ---------------------- | -------------------------------------------------------------- |
| Предложены условия     | Переносим данные в СВОД                                        |
| Запрос доп. информации | Отправляем брокеру сообщение, в СВОД данные из КЛ не переносим |
| Отказ                  | Переносим данные в СВОД                                        |

2. ### Обработка блока с Франшизой

   Далее читаем со строки 43-46, блок "6. Франшиза".

   - Если в ячейке А43 значение "6. Франшиза", то начинаем обработку этого блока.
   - Проверка содержимого ячеек в строке 44, если значения не соответствуют, завершаем обработку, так как файл не соответствует шаблону.
      - D44 = ОТ ВСЕХ РИСКОВ
      - G44 = ОТ ПОИМЕНОВАННЫХ РИСКОВ
   - Проверка содержимого в ячейке A45, если значение равно "6.1 Франшиза, запрошенная СББ", то начинаем чтение блока SBB, где сохраняем параметры из ячеек. Если ячейка пустая, сохраняем значение параметра как `null`. ::Но, минимум одно из полей с суммой должно быть заполнено.::

Таблица 3. Маппинг полей 45 строки.

| **Ячейка** | **Поле КЛ**                      | **Параметр**                  |
| ---------- | -------------------------------- | ----------------------------- |
| D45        | Сумма франшизы СББ allRisks      | SBBFranchiseValueOfAllRisks   |
| E45        | Выбор из значений из справочника | SBBFranchiseTypeOfAllRisks    |
| G45        | Сумма франшизы СББ namedRisks    | SBBFranchiseValueOfNamedRisks |
| H45        | Выбор из значений из справочника | SBBFranchiseTypeOfNamedRisks  |

   - Проверка содержимого в ячейке A46, если значение равно "6.2 Франшиза, предложенная СК", то начинаем чтение блока IC, где сохраняем параметры из ячеек. Если ячейка пустая, сохраняем значение параметра как `null`. ::Но, минимум одно из полей с суммой должно быть заполнено.::

Таблица 4. Маппинг полей 46 строки.

| **Ячейка** | **Поле КЛ**                      | **Параметр**                 |
| ---------- | -------------------------------- | ---------------------------- |
| D46        | Сумма франшизы СК allRisks       | ICFranchiseValueOfAllRisks   |
| E46        | Выбор из значений из справочника | ICFranchiseTypeOfAllRisks    |
| G46        | Сумма франшизы СК namedRisks     | ICFranchiseValueOfNamedRisks |
| H46        | Выбор из значений из справочника | ICFranchiseTypeOfNamedRisks  |

- Поля E45, E46, H45, H46 могут иметь одно из 4 значений в соответствии со справочником видов франшиз - Таблица 5. Процентные величины требуют преобразования в абсолютные значения для дальнейших расчетов.

   Таблица 5. Справочник видов франшиз.

| Вид франшизы           | **Формат**                               | **Преобразование**                                                              | **Параметр**            |
| ---------------------- | ---------------------------------------- | ------------------------------------------------------------------------------- | ----------------------- |
| Безусловная процентная | %, 2 знака после занятой (пример: 0,50%) | в абсолютное, с округлением до 10-ти тысячных<br>(пример: 0,50 / 100  = 0,0050) | UnconditionalPercentage |
| Безусловная абсолютная | 10000,5000                               | округление до сотых (пример: 10000,50)                                          | UnconditionalAbsolute   |
| Условная процентная    | %, 2 знака после занятой (пример: 0,50%) | 0,50 / 100  = 0,0050                                                            | ConditionalPercentage   |
| Условная абсолютная    | 10000,5000                               | округление до сотых (пример: 10000,50)                                          | ConditionalAbsolute     |

Таблица 6. Полный маппинг полей блока "6.Франшиза".

| **Ячейка** | **Поле КЛ**                      | **Описание/Параметр**               |
| ---------- | -------------------------------- | ----------------------------------- |
| A43        | 6. Франшиза                      | Начало работы                       |
| D44        | ОТ ВСЕХ РИСКОВ                   | Проверка значения                   |
| G44        | ОТ ПОИМЕНОВАННЫХ РИСКОВ          | Проверка значения                   |
| A45        | 6.1 Франшиза, запрошенная СББ    | Проверка значения, начало блока SBB |
| D45        | Сумма франшизы СББ allRisks      | SBBFranchiseValueOfAllRisks         |
| E45        | Выбор из значений из справочника | SBBFranchiseTypeOfAllRisks          |
| G45        | Сумма франшизы СК namedRisks     | SBBFranchiseValueOfNamedRisks       |
| H45        | Выбор из значений из справочника | SBBFranchiseTypeOfNamedRisks        |
| A46        | 6.2 Франшиза, предложенная СК    | Проверка значения, начало блока IC  |
| D46        | Сумма франшизы СК allRisks       | ICFranchiseValueOfAllRisks          |
| E46        | Выбор из значений из справочника | ICFranchiseTypeOfAllRisks           |
| G46        | Сумма франшизы СК namedRisks     | ICFranchiseValueOfNamedRisks        |
| H46        | Выбор из значений из справочника | ICFranchiseTypeOfNamedRisks         |

**JSON блока "6. Франшиза"**

```javascript
{
      "Франшиза": {
        "От всех рисков": {
          "6.1 Франшиза, запрошенная СББ": {
            "Значение": 0.0005,
            "Тип": "Условная процентная"
          },
          "6.2 Франшиза, предложенная СК": {
            "Значение": 0.30,
            "Тип": "Условная абсолютная"
          }
        },
        "От поименованных рисков": {
          "6.1 Франшиза, запрошенная СББ": {
            "Значение": 0.0004,
            "Тип": "Безусловная процентная"
          },
          "6.2 Франшиза, предложенная СК": {
            "Значение": 0.50,
            "Тип": "Безусловная абсолютная"
          }
        }
      }
  }
//ининглиш плиз
  {
      "Franchise": {
        "allRisks": {
          "SBBFranchise": {
            "Value": 0.0005,
            "Type": "UnconditionalPercentage"
          },
          "ICFranchise": {
            "Value": 0.30,
            "Type": "UnconditionalAbsolute"
          }
        },
        "namedRisks": {
          "SBBFranchise": {
            "Value": 0.0004,
            "Type": "UnconditionalPercentage"
          },
          "ICFranchise": {
            "Value": 0.50,
            "Type": "UnconditionalAbsolute"
          }
        }
      }
	}
```

3. ### Обработка блока с ответом СК
- Если в ячейке А48 значение "7. Ответ СК/андеррайтера", то начинаем обработку этого блока.
- В ячейке A49 должно быть указано одно из значений:

Таблица 7. Список категорий ИМЩ

| НЕДВИЖИМОЕ ИМУЩЕСТВО                 |
| ------------------------------------ |
| ДВИЖИМОЕ ИМУЩЕСТВО                   |
| ТМЦ                                  |
| ЗЕМЕЛЬНЫЕ УЧАСТКИ                    |
| ОБЪЕКТЫ НЕЗАВЕРШЕННОГО СТРОИТЕЛЬСТВА |

Формирование JSON в соответствии с полями нового КЛ - Настя

Алгоритм обработки КЛ и формирования СВОДа

Далее, отправка распаршенного) JSON в CRM. ВОПРОС: CRM будет формировать свод или сервис КЛ должен передать уже JSON в формате СВОДА?

**Получение файла:**

Загрузка Excel-файлов (формат .xls, .xlsx, .xlsm) через веб-интерфейс после поступления ответов от СК в раздел CRM «ДЕЛА» и подтверждения брокера для запуска сервиса Свода.
Пример: KLResult_e6c48b6d-a7af-4fed-9156-c9c8c7142426, шаблон KLResult_GUID

**Валидация файла**

- Проверка наличия обязательного листа - "КЛ"
- Проверка значения "Предложены условия" в поле **G4**
- Проверка наличия поля: Ответ СК/андеррайтера.
- Проверка наличия в  поле «Ответ СК/андеррайтера» хотя бы одного блока из: ::Недвижимое имущество, Движимое имущество, ТМЦ, Земельные участки, Объекты незавершенного строительства::.
- Как минимум одна пара "Суммы" (Оценочная стоимость или Залоговая стоимость)  - "Нетто-тариф" (Оценочная стоимость или Залоговая стоимость) соответственно должны быть заполнены. *Если ни одно из полей с тарифом не заполнено, такой котировочный лист не участвует в формировании Сводной формы.*

**Алгоритм парсинга полученного КЛ**

0. Валидация файла**:**
- Проверка наличия обязательного листа - "КЛ"
- Проверка значения в поле **G4 =** "Предложены условия"  **::Если нет, то ?::**

*Далее: Обрабатываем поля после 43 строки "6. Ответ СК/андеррайтера" в границах столбцов A-K.*

2. Ищем в поле **A44** одно из значений:

   \- НЕДВИЖИМОЕ ИМУЩЕСТВО

   \- ДВИЖИМОЕ ИМУЩЕСТВО

   \- ТМЦ

   \- ЗЕМЕЛЬНЫЕ УЧАСТКИ

   \- ОБЪЕКТЫ НЕЗАВЕРШЕННОГО СТРОИТЕЛЬСТВА

   2.1 Если найдены, сохраняем наименование блока и обрабатываем последующие строки по данному блоку до значения в столбце A = "Комментарий UW (опционально)".

   2.2 Если значения не найдены. завершаем поиск, так как "Блок "Ответ СК/андеррайтера" не найден".

3. В поле **A45** ищем "ОТ ВСЕХ РИСКОВ" и/или в поле **G45** "ОТ ПОИМЕНОВАННЫХ РИСКОВ"

   3.1 если есть оба поля, то:

   - Проверяем структуру столбцов:
      - A47, G47 = "С франшизой" или "Без франшизы"
      - B47, H47 = "Оценочная стоимость"
      - D47, J47 = "Залоговая стоимость"
      - A48, G48 = "Суммы"
   - Если все ячейки заполнены, то:
      - Читаем значения сумм в ячейках B48, D48, H48, J48
         - Если ячейка пустая, помечаем её как `null`
         - Если не пустая, проверяем что это ::целое::? число сохраняем значение. В итоговом json будет значения параметра `amount`.
   - B48 и/или D48 есть число.
   - H48, J48

   2.2 если есть только "ОТ ВСЕХ РИСКОВ":

   2.3 если есть только "ОТ ПОИМЕНОВАННЫХ РИСКОВ":

\- Если найдено значение "НЕДВИЖИМОЕ ИМУЩЕСТВО", то ищем строку

Если ячейка пустая, помечаем её как `null`.

| **Ячейка** | **Поле КЛ**                      | **Описание**               | **Параметр** |
| ---------- | -------------------------------- | -------------------------- | ------------ |
| A43        | 6. Франшиза                      | Начало работы              |              |
| D44        | ОТ ВСЕХ РИСКОВ                   | Проверка значения в ячейке |              |
| G44        | ОТ ПОИМЕНОВАННЫХ РИСКОВ          |                            |              |
| A45        | 6.1 Франшиза, запрошенная СББ    |                            |              |
| D45        | Сумма франшизы СББ allRisks      |                            |              |
| E45        | Выбор из значений из справочника |                            |              |
| G45        | Сумма франшизы СК namedRisks     |                            |              |
| H45        | Выбор из значений из справочника |                            |              |
| A46        | 6.2 Франшиза, предложенная СК    |                            |              |
| D46        |                                  |                            |              |
| E46        |                                  |                            |              |
| G46        |                                  |                            |              |
| H46        |                                  |                            |              |

